


<!-- src/app/features/service-confiance/fiche-technique/service-confiance-ft-list-page-modele.component.html -->
<div class="page-container">
  <h2 class="page-title">Liste des demandes Services de Confiance</h2>

  <!-- üîç Zone de filtres -->
  <div class="filter-bar">
    <!-- Recherche / Nom du client -->
    <mat-form-field appearance="outline">
      <mat-label>Nom du client</mat-label>
      <input matInput placeholder="Nom du client" [(ngModel)]="nomClient" (input)="chercher()" />
    </mat-form-field>

    <!-- Statut -->
    <mat-form-field appearance="outline">
      <mat-label>Statut</mat-label>
      <mat-select [(ngModel)]="statusFilter" (selectionChange)="chercher()">
        <mat-option *ngFor="let item of statutFicheTechniques" [value]="item.id">{{ item.libelle }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Date d√©but -->
    <mat-form-field appearance="outline">
      <mat-label>Du</mat-label>
      <input matInput [matDatepicker]="fromPicker" [(ngModel)]="startDate" (dateChange)="chercher()" />
      <mat-datepicker-toggle matIconSuffix [for]="fromPicker"></mat-datepicker-toggle>
      <mat-datepicker #fromPicker></mat-datepicker>
    </mat-form-field>

    <!-- Date fin -->
    <mat-form-field appearance="outline">
      <mat-label>Au</mat-label>
      <input matInput [matDatepicker]="toPicker" [(ngModel)]="endDate" (dateChange)="chercher()" />
      <mat-datepicker-toggle matIconSuffix [for]="toPicker"></mat-datepicker-toggle>
      <mat-datepicker #toPicker></mat-datepicker>
    </mat-form-field>

    <!-- Cat√©gorie de service -->
    <mat-form-field appearance="outline">
      <mat-label>Cat√©gorie de service</mat-label>
      <mat-select [(ngModel)]="serviceFilter" (selectionChange)="chercher()">
        <mat-option *ngFor="let item of produits" [value]="item.id">{{ item.libelle }}</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Boutons r√©initialiser et cr√©er FT -->
    <button class="upload-label-reset" (click)="reset()">
      <mat-icon>refresh</mat-icon>
      R√©initialiser
    </button>

    <button class="upload-label-create" (click)="crud(null, operations.create)">
      <mat-icon>add_circle_outline</mat-icon>
      FT service de confiance
    </button>
  </div>

  <!-- üìÅ Zone import / actions -->
  <div class="upload-action-section">
    <label for="fileUpload" class="upload-label">
      <mat-icon>cloud_upload</mat-icon>
      Importer un fichier
    </label>
    <input id="fileUpload" type="file" hidden/>
    <span class="file-name"></span>

    <button class="upload-label-print">
      <mat-icon>print</mat-icon>
      Imprimer
    </button>

    <button class="upload-label-export">
      <mat-icon>file_download</mat-icon>
      Exporter
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- üóÇÔ∏è Liste des demandes avec checkbox -->
  <div class="table-container">
    <table class="custom-table">
      <thead>
        <tr>
          <th><mat-checkbox></mat-checkbox></th>
          <th>Nom du Client</th>
          <th>Cat√©gorie de Service</th>
          <th>Date soumission</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let element of ficheTechniques">
          <td><mat-checkbox [(ngModel)]="element.selected"></mat-checkbox></td>
          <td>{{ element.client_nom }}</td>
          <td>{{ getCategorie(element.categorie_produit) }}</td>
          <td>{{ element.date_creation | date:'dd/MM/yyyy' }}</td>
          <td>
            <span class="status-chip" [ngClass]="{
              'status-new': element.statut?.code==='INIT',
              'status-progress': element.statut?.code==='FTD',
              'status-valid': element.statut?.code==='VALIDE'
            }">{{ element.statut?.libelle }}</span>
          </td>
          <td>
            <!-- Boutons action dans chaque ligne -->
            <button mat-icon-button color="primary" [matMenuTriggerFor]="menu">
              <mat-icon>settings</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item class="btn_edit" (click)="crud(element, operations.update)">
                <mat-icon color="primary">edit</mat-icon>
                Modifier
              </button>
              <button *ngIf="element.statut?.code==='INIT' && hasOperationCode('TRANSMETTRE_FICHE')"
                      mat-menu-item (click)="crud(element, operations.transmettre)">
                <mat-icon color="warn">edit</mat-icon>
                Transmettre
              </button>
              <button *ngIf="element.statut?.code==='FTD' && hasOperationCode('AVIS_TECHNIQUE_FICHE')"
                      mat-menu-item (click)="onSetAvis(element, operations.transmettre)">
                <mat-icon color="warn">check</mat-icon>
                Donner un avis
              </button>
              <button *ngIf="element.statut?.id>5 && hasOperationCode('RETRAIT_FICHE')"
                      mat-menu-item (click)="onRetraitAutorisation(element, operations.transmettre)">
                <mat-icon color="warn">check</mat-icon>
                Retrait autorisation/licence
              </button>
              <button mat-menu-item class="btn_delete" (click)="onDelete(element)">
                <mat-icon color="warn">delete</mat-icon>
                Supprimer
              </button>
            </mat-menu>
          </td>
        </tr>

        <tr>
          <td colspan="6" class="empty-row">Aucune correspondance trouv√©e dans la base de donn√©es correspondant au crit√®re de recherche</td>
        </tr>
      </tbody>
    </table>

    <mat-paginator
      [pageSizeOptions]="[3,5,10,15]"
      [pageSize]="5"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
