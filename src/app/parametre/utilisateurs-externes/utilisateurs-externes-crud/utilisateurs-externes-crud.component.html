<!-- src/app/type-directions/pages/type-direction/utilisateurs-externes-crud/utilisateurs-externes-crud.component.html -->

<mat-card>

  <div class="page-title">
    <h2>{{ title }}</h2>
  </div>

  <!-- Messages d'erreur -->
  <div *ngIf="errorMessage?.length > 0" class="alert-box">
    <div *ngFor="let msg of errorMessage" class="alert-line">
      <mat-icon class="alert-icon">error</mat-icon>
      <span>{{ msg }}</span>
    </div>
  </div>

  <section class="list-box">

    <!-- ✅ Le form englobe header + body -->
    <form [formGroup]="form" (ngSubmit)="crud()">

      <div class="list-header list-header--with-actions">
        <h3 class="list-title">
          <ng-container *ngIf="data_operation===operations.create">Nouvel enregistrement</ng-container>
          <ng-container *ngIf="data_operation===operations.update">Mise à jour</ng-container>
          <ng-container *ngIf="data_operation===operations.details">Détails</ng-container>
        </h3>

        <!-- ✅ Actions à droite (comme la capture) -->
        <div class="header-actions">

          <button mat-flat-button color="primary" type="submit"
                  [disabled]="form.invalid"
                  *ngIf="data_operation===operations.create || data_operation===operations.update">
            <mat-icon>save</mat-icon>
            {{ bouton_names.save }}
          </button>

          <button mat-stroked-button color="warn" type="button" mat-dialog-close>
            <mat-icon>close</mat-icon>
            Fermer
          </button>

        </div>
      </div>

      <div class="list-body">
        <div class="role-crud-scroll">
          <div class="blank-row"></div>

          <!-- ✅ on garde tes champs, mais SANS re-déclarer un form -->
          <div class="form-grid">

            <!-- 1) Nom + Prénom -->
            <div class="form-row-2">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Nom</mat-label>
                <input matInput appUppercase formControlName="last_name" placeholder="Nom"
                       [readonly]="isDetails()">
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Prénom</mat-label>
                <input matInput appUppercase formControlName="first_name" placeholder="Prénom"
                       [readonly]="isDetails()">
              </mat-form-field>
            </div>

            <div class="blank-row"></div>

            <!-- 2) Téléphone + Email -->
            <div class="form-row-2">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Téléphone</mat-label>
                <input matInput formControlName="telephone" placeholder="Téléphone"
                       [readonly]="isDetails()">
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" placeholder="Email"
                       [readonly]="isDetails()">
                <mat-error *ngIf="form.get('email')?.hasError('email')">Email invalide</mat-error>
              </mat-form-field>
            </div>

            <div class="blank-row"></div>

            <!-- 3-4) Direction + Username 50/50 -->
            <div class="form-row-dir-user">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Direction</mat-label>
                <mat-select formControlName="direction" [disabled]="isDetails()">
                  <mat-option [value]="null">—</mat-option>
                  <mat-option *ngFor="let d of directions" [value]="d.id">
                    {{ d.libelle }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Username</mat-label>
                <input matInput formControlName="username" placeholder="Username"
                       matTooltip="Username"
                       [readonly]="isDetails()" required>
                <mat-error *ngIf="form.get('username')?.hasError('required')">
                  Username obligatoire
                </mat-error>
              </mat-form-field>
            </div>

            <div class="blank-row"></div>

            <!-- 6) Rôles : autocomplete + tableau -->
            <div class="roles-block">

              <div class="roles-add" *ngIf="!isDetails()">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Ajouter un rôle</mat-label>
                  <input matInput
                         [formControl]="roleSearchCtrl"
                         [matAutocomplete]="rolesAuto"
                         placeholder="Rechercher un rôle..."
                         autocomplete="off">

                  <mat-autocomplete #rolesAuto="matAutocomplete"
                                    [displayWith]="displayRole"
                                    (optionSelected)="onRolePicked($event)">
                    <mat-option *ngFor="let r of (filteredRoles$ | async)" [value]="r">
                      {{ r.libelle }} <span *ngIf="r.code">({{ r.code }})</span>
                    </mat-option>

                    <mat-option *ngIf="(filteredRoles$ | async)?.length === 0" disabled>
                      Aucun rôle disponible
                    </mat-option>
                  </mat-autocomplete>

                  <mat-hint>Seuls les rôles non encore attribués sont proposés</mat-hint>
                </mat-form-field>
              </div>

              <div class="mat-elevation-z2 compact-table roles-table">
                <table mat-table [dataSource]="assignedRolesDS" style="width:100%">

                  <ng-container matColumnDef="libelle">
                    <th mat-header-cell *matHeaderCellDef>Rôle</th>
                    <td mat-cell *matCellDef="let r">{{ r.libelle }}</td>
                  </ng-container>

                  <ng-container matColumnDef="code">
                    <th mat-header-cell *matHeaderCellDef>Code</th>
                    <td mat-cell *matCellDef="let r">{{ r.code || '—' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="col-actions">Actions</th>
                    <td mat-cell *matCellDef="let r" class="col-actions">
                      <button mat-icon-button color="warn"
                              type="button"
                              matTooltip="Retirer"
                              (click)="removeRole(r)"
                              [disabled]="isDetails()">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="assignedRolesColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: assignedRolesColumns"></tr>

                  <tr mat-row *matNoDataRow>
                    <td class="mat-cell" [attr.colspan]="assignedRolesColumns.length">
                      Aucun rôle attribué
                    </td>
                  </tr>

                </table>

                <div class="roles-error"
                     *ngIf="form.get('liste_roles')?.touched && form.get('liste_roles')?.hasError('minArrayLength')">
                  Au moins un rôle est obligatoire
                </div>
              </div>

            </div>

            <div class="blank-row"></div>

          </div>
        </div>
      </div>

    </form>
  </section>

</mat-card>
